#QC
fastqc -t 16 *.gz -o ./qc
ls ./*fq.gz | while read i;
do
i=${i/_1.fq.gz/}
fastp -w 56 -L -i ${i}_1.fq.gz -o ${i}_1_clean.fq.gz -I ${i}_2.fq.gz -O ${i}_2_clean.fq.gz
done

#bulid index
STAR --runThreadN 56 --runMode genomeGenerate --genomeDir ./ \
  --genomeFastaFiles Ovis_aries_rambouillet.ARS-UI_Ramb_v2.0.dna.toplevel.fa \
  --sjdbGTFfile Ovis_aries_rambouillet.ARS-UI_Ramb_v2.0.113.chr.gtf

#alignment
ls *_1_clean.fq.gz | while read i;
do
i=${i/_1_clean.fq.gz/}
STAR --runThreadN 32 \
--genomeDir /home/baoqi/rna/genome  \
--chimSegmentMin  10 \
--readFilesIn ${i}_1_clean.fq.gz ${i}_2_clean.fq.gz \
--outFileNamePrefix ./${i}-STAR
--outTmpDir tmp
--readFilesCommand zcat
--limitBAMsortRAM 120000000000
done

#identified ciroRNA
ls *junction | while read id;
do
CIRCexplorer2 parse -t STAR $id > ${id}_parse.log
done


#conda install bioconda::ucsc-gtftogenepred
#https://hgdownload.soe.ucsc.edu/admin/exe/linux.x86_64/
wget https://link.zhihu.com/?target=http%3A//hgdownload.soe.ucsc.edu/admin/exe/linux.x86_64/gtfToGenePred
gtfToGenePred input.gtf output.genePred

#the genePred you got whitout the colnum of genename,so your should add it
python  python extract_pairID.py
#using function merge in R to merge genePred and pairID.txt



#annotate
ls *bed | while read id; do CIRCexplorer2 annotate -r ../../genome/ovis.genePred.txt -g ../../genome/Ovis_aries_rambouillet.ARS-UI_Ramb_v2.0.dna.toplevel.fa -b $id -o ${id}_know.txt;done

#quant
ls *_1_clean.fq.gz | while read i;
do
i=${i/_1_clean.fq.gz/}
CIRIquant -t 16 \
          -1 ${i}_1_clean.fq.gz \
          -2 ${i}_2_clean.fq.gz \
          --config /home/baoqi/rna/clean_fq/annotate/config.yml \
          -o /home/baoqi/rna/clean_fq/quant \
          -p ${i} \
          --circ /home/baoqi/rna/clean_fq/annotate/${i}-STARChimeric.out.junction_back_spliced_junction.bed_know.txt \
          --tool CIRCexplorer2
done

